name: Playwright Tests
on:
  push:
    branches: [ main, staging ]
  pull_request:
    branches: [ main, staging ]

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: 'lts/*'

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # Setup Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    # Setup Node.js
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    # Install pipenv
    - name: Install pipenv
      run: pip install pipenv
    
    # Install Python dependencies
    - name: Install Python dependencies
      run: pipenv sync --dev
    
    # Install Node dependencies (frontend)
    - name: Install frontend dependencies
      run: npm ci
    
    # Build frontend
    - name: Build frontend
      run: npm run build
      working-directory: ./app
    
    # Start Docker Compose services (test databases)
    - name: Start test databases
      run: |
        docker compose -f e2e/docker-compose.test.yml up -d
        # Wait for databases to be healthy
        echo "Waiting for databases to be ready..."
        sleep 20
        docker ps -a
        # Verify all containers are running
        docker compose -f e2e/docker-compose.test.yml ps
    
    # Start FalkorDB (Redis graph database)
    - name: Start FalkorDB
      run: |
        docker run -d --name falkordb-test -p 6379:6379 falkordb/falkordb:latest
        echo "Waiting for FalkorDB to be ready..."
        # Wait for FalkorDB to accept connections (try for 30 seconds)
        for i in {1..30}; do
          if docker exec falkordb-test redis-cli PING > /dev/null 2>&1; then
            echo "FalkorDB is ready!"
            break
          fi
          echo "Waiting... attempt $i/30"
          sleep 1
        done
        # Verify FalkorDB is accessible from host
        if command -v redis-cli &> /dev/null; then
          redis-cli -h localhost -p 6379 PING || echo "redis-cli not available, skipping host check"
        fi
        docker ps -a
    
    # Start the FastAPI application
    - name: Start FastAPI application
      run: |
        # Start server in background directly with pipenv
        pipenv run uvicorn api.index:app --host localhost --port 5000 > /tmp/uvicorn.log 2>&1 &
        UVICORN_PID=$!
        echo "Started server with PID: $UVICORN_PID"
        # Wait for app to start
        echo "Waiting for application to start..."
        for i in {1..30}; do
          if curl -f http://localhost:5000/ 2>/dev/null; then
            echo "Application started successfully!"
            break
          fi
          echo "Waiting... attempt $i/30"
          sleep 1
          if [ $i -eq 30 ]; then
            echo "Failed to start application after 30 seconds"
            echo "=== Server logs ==="
            cat /tmp/uvicorn.log
            exit 1
          fi
        done
      env:
        PYTHONUNBUFFERED: 1
        FASTAPI_SECRET_KEY: test-secret-key-for-ci
        APP_ENV: development
        FASTAPI_DEBUG: False
        FALKORDB_URL: redis://localhost:6379
        DISABLE_MCP: true
    
    # Install Playwright browsers
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium firefox
    
    # Run Playwright tests
    - name: Run Playwright tests
      run: npx playwright test --reporter=list
      env:
        CI: true
    
    # Upload test results on failure
    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
    
    # Upload test screenshots on failure
    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-results
        path: test-results/
        retention-days: 30
    
    # Cleanup - Stop all containers
    - name: Cleanup Docker containers
      if: always()
      run: |
        docker compose -f e2e/docker-compose.test.yml down -v || true
        docker stop falkordb-test || true
        docker rm falkordb-test || true
